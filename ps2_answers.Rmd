---
title: "Problem Set 1"
subtitle: "Thompson sampling"
author: "Patrick Altmeyer"
date: "`r format(Sys.Date(), '%d %B, %Y')`"
output: 
  bookdown::html_document2:
    code_folding: show
    number_sections: false
    toc: true
    toc_float: true
bibliography: bib.bib
---

```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo = TRUE, fig.align = "center")
library(data.table)
lapply(
  list.files("R", pattern = "\\.R"),
  function(file) {
    source(file = file.path("R",file))
  }
)
```

# An empirical evalutation of Thompson Sampling [@chapelle2011empirical]

First we will simulate the Bernoulli Multi Armed Bandit (MAB) problem.

```{r}
eps <- 0.1
K <- 10
T_ <- 1000
prob <- c(0.5,rep(0.5-eps,K-1))
bernoulli_mab <- mab(prob, horizon = T_)
```

## Performance benchmark

Since we are looking at computationally very intensive computations, I have chosen to compile the algorithms in C++ through `Rcpp`.^[This has in part been an exercise for me to get more familiar with `Rcpp`.] This leads to a massive boost in computation performance: Figure \@ref(fig:benchmark) shows the substantial reduction in computing time due to compiling the UCB algorithm through `Rcpp`.

```{r benchmark, message=FALSE, warning=FALSE, fig.cap="Reduction in computing time due to compiling the UCB algorithm through `Rcpp`."}
library(microbenchmark)
library(ggplot2)
mb <- microbenchmark(
    "R" = {ucb_R(bernoulli_mab)},
    "Rcpp" = {ucb_Rcpp(bernoulli_mab)},
    times = 100
)
autoplot(mb)
```

## UCB

```{r}
eps <- 0.1
K <- 10
T_ <- 1000000
prob <- c(0.5,rep(0.5-eps,K-1))
bernoulli_mab <- mab(prob, horizon = T_)
```

```{r}
fitted <- ucb_Rcpp(bernoulli_mab)
plot(fitted)
```

## Thompson sampling

```{r}
eps <- 0.1
K <- 10
T_ <- 10000
prob <- c(0.5,rep(0.5-eps,K-1))
bernoulli_mab <- mab(prob, horizon = T_)
```

```{r}
fitted_thom <- thompson_R(bernoulli_mab)
fitted_ucb <- ucb_Rcpp(bernoulli_mab)
```

First, let us set up a grid for the simulation:

```{r}
t_0 <- 100
T_ <- 10000
K <- c(10,100)
eps <- c(0.02,0.1)
grid <- data.table(expand.grid(K=K,eps=eps,t=t_0:T_))
```

```{r}
grid[,lower_bound:=lb(t,c(0.5,rep(0.5-eps,K-1)),kl_bernoulli),by=.(K,eps,t)]
# shift to go through origin:
grid[,lower_bound_adj:=lower_bound - lb(100,c(0.5,rep(0.5-eps,K-1)),kl_bernoulli),by=.(K,eps)]
```

```{r}
library(ggplot2)
library(scales)
p <- ggplot(data=grid) +
  geom_line(aes(x=t, y=lower_bound_adj)) +
  scale_x_log10(
    breaks = trans_breaks("log10", function(x) 10^x),
    labels = trans_format("log10", math_format(10^.x))
  ) +
  facet_wrap(eps ~ K, scales="free") +
  labs(
    x="T",
    y="Regret"
  )
p
```



